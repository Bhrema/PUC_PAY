<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>PUCPAY</title>

    <!-- Google Font: Source Sans Pro -->
    <link
      rel="stylesheet"
      href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700&display=fallback"
    />
    <!-- Font Awesome -->
    <link
      rel="stylesheet"
      href="../node_modules/@fortawesome/fontawesome-free/css/all.min.css"
    />
    <!-- icheck bootstrap -->
    <link
      rel="stylesheet"
      href="node_modules/bootstrap/plugins/icheck-bootstrap/icheck-bootstrap.min.css"
    />
    <!-- Theme style -->
    <link
      rel="stylesheet"
      href="../node_modules/admin-lte/dist/css/adminlte.min.css"
    />
  </head>

  <body
    class="
      hold-transition
      dark-mode
      sidebar-mini
      layout-fixed layout-navbar-fixed layout-footer-fixed
    "
  >
    <div class="wrapper">
      <!-- Navbar -->
      <nav class="main-header navbar navbar-expand navbar-dark">
        <!-- Left navbar links -->
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" data-widget="pushmenu" href="#" role="button"
              ><i class="fas fa-bars"></i
            ></a>
          </li>
          <li class="nav-item d-none d-sm-inline-block">
            <a href="index3.html" class="nav-link">Home</a>
          </li>
          <li class="nav-item d-none d-sm-inline-block">
            <a href="#" class="nav-link">Contato</a>
          </li>
        </ul>

        <!-- Right navbar links -->
        <ul class="navbar-nav ml-auto">
          <button
            type="button"
            id="btnLogout"
            class="btn btn-outline-danger float-right"
          >
            Logout
          </button>
          <!-- Navbar Search -->
          <li class="nav-item">
            <a
              class="nav-link"
              data-widget="navbar-search"
              href="#"
              role="button"
            >
              <i class="fas fa-search"></i>
            </a>
            <div class="navbar-search-block">
              <form class="form-inline">
                <div class="input-group input-group-sm">
                  <input
                    class="form-control form-control-navbar"
                    type="search"
                    placeholder="Search"
                    aria-label="Search"
                  />
                  <div class="input-group-append">
                    <button class="btn btn-navbar" type="submit">
                      <i class="fas fa-search"></i>
                    </button>
                    <button
                      class="btn btn-navbar"
                      type="button"
                      data-widget="navbar-search"
                    >
                      <i class="fas fa-times"></i>
                    </button>
                  </div>
                </div>
              </form>
            </div>
          </li>
        </ul>
      </nav>
      <!-- /.navbar -->

      <!-- Main Sidebar Container -->
      <aside class="main-sidebar sidebar-dark-primary elevation-4">
        <!-- Brand Logo -->
        <a href="index3.html" class="brand-link">
          <!-- <img src="dist/img/AdminLTELogo.png" alt="AdminLTE Logo" class="brand-image img-circle elevation-3" style="opacity: .8"> -->
          <span class="brand-text font-weight-light" style="margin-left:33px;">PUCPAY</span>
        </a>

        <!-- Sidebar -->
        <div class="sidebar">
          <!-- Sidebar user panel (optional) -->
          <div class="user-panel mt-3 pb-3 mb-3 d-flex">
            <div class="image">
              <i class="fas-fa-user"></i>
            </div>
            <div class="info">
              <a href="#" class="d-block" id="session-name">Faça seu login</a>
            </div>
          </div>

          <!-- Sidebar Menu -->
          <nav class="mt-2">
            <ul
              class="nav nav-pills nav-sidebar flex-column"
              data-widget="treeview"
              role="menu"
              data-accordion="false"
            >
              <!-- Add icons to the links using the .nav-icon class
                 with font-awesome or any other icon font library -->
              <li class="nav-item menu-open">
                <ul class="nav nav-treeview">

              <li class="nav-item">
                <a href="./dashboard-restaurante.html" class="nav-link">
                  <i class="far fa-circle nav-icon"></i>
                  <p>Perfil</p>
                </a>
              </li>
            </ul>
            <a href="./dashboard-restaurante-produtos.html" class="nav-link active">
              <i class="nav-icon fas fa-tachometer-alt"></i>
              <p>Produtos</p>
            </a>
            <ul class="nav nav-treeview">
              <li class="nav-item">
                <a
                  href="./dashboard-restaurante-historico.html"
                  class="nav-link"
                >
                  <i class="far fa-circle nav-icon"></i>
                  <p>Histórico</p>
                </a>
              </li>
              
              <li class="nav-item">
                <a href="./dashboard-restaurante-cad-produtos.html" class="nav-link">
                  <i class="fa fa-plus"></i>
                  <p>Registrar Produto</p>
                </a>
              </li>

            </ul>
          </nav>
          <!-- /.sidebar-menu -->
        </div>
        <!-- /.sidebar -->
      </aside>

      <!-- CONTEÚDO DO DASHBOARD -->
      <div class="content">
        <table
          cellpadding="5"
          cellspacing="5"
          style="position: relative; top: 100px; left: 300px; width: 75%"
          id="table"
        >
          <tbody id="tbody" style="display: flex">
            <tr style="width: 200px" ;>
              <td>
                <a href="#">
                  <div class="col-lg-4 col-md-6 mb-4">
                    <div class="card">
                      <div
                        class="
                          bg-image
                          hover-zoom
                          ripple ripple-surface ripple-surface-light
                        "
                        data-mdb-ripple-color="light"
                      >
                        <img
                          src="https://mdbcdn.b-cdn.net/img/Photos/Horizontal/E-commerce/Products/img%20(4).webp"
                          class="w-100"
                        />
                        <a href="#!"></a>
                      </div>
                      <div class="card-body">
                        <a href="" class="text-reset">
                          <h5 class="card-title mb-3" id="name">
                            Nome do Produto
                          </h5>
                        </a>
                        <br />
                        <hr />
                        <h6 class="mb-3" id="price">$Price</h6>
                      </div>
                      <button type="button" class="btn btn-primary">
                        Adicionar ao carrinho
                      </button>
                    </div>
                  </div>
                </a>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
      <!-- /.content-wrapper -->

      <!-- Control Sidebar -->
      <aside class="control-sidebar control-sidebar-dark">
        <!-- Control sidebar content goes here -->
      </aside>
      <!-- /.control-sidebar -->

      <!-- Main Footer -->
      <footer class="main-footer">
        <strong
          >Copyright &copy; 2023
          <a href="https://trello.com/b/1P1e72Ss/projeto">PUCPAY</a>.</strong
        >

        All rights reserved.
        <div class="float-right d-none d-sm-inline-block">
          <b>Version</b> 3.2.0
        </div>
      </footer>
    </div>
    <!-- ./wrapper -->

    <script>
      const session = localStorage.getItem("session");
      const sessionJson = JSON.parse(session);

      const userNameSession = document.getElementById("session-name");
      if (!sessionJson.name) {
        userNameSession.innerText = "Faça seu login!";
      }

      userNameSession.innerText = sessionJson.name;

      async function showProducts() {
        const urlParams = new URLSearchParams(window.location.search);
        const restaurantId = sessionJson.id;
        const response = await fetch(
          `http://localhost:3000/products/restaurant/${restaurantId}`,
          {
            method: "GET",
            headers: {
              "Content-Type": "application/json",
            },
          }
        );
        const responseData = await response.json();
        const products = responseData;

        const tbody = document.getElementById("tbody");
        tbody.innerHTML = "";

        function createProductElement(product) {
          const tableRow = document.createElement("tr");
          tableRow.style.width = "250px";
          tableRow.innerHTML = `
                <td>
                  <a href="#">
                    <div class="col-lg-4 col-md-6 mb-4">
                      <div class="card" style="width:204.3px;">
                        <div class="bg-image hover-zoom ripple ripple-surface ripple-surface-light"
                          data-mdb-ripple-color="light">
                          <img src="/uploads/${product.image}" style="width:204.3px; height:200px" />
                          <a href="#!"></a>
                        </div>
                        <div class="card-body">
                          <a href="" class="text-reset">
                            <h5 class="card-title mb-3">${product.name}</h5>
                          </a>
                          <br>
                          <hr>
                          <h6 class="mb-3">R$${product.price}</h6>
                        </div>
                        <div>
                          <button type="button" class="btn btn-danger" style="width:100px; display:inline;" id="product-deletar-${product.id}">Deletar</button>
                          <button type="button" class="btn btn-primary" style="width:100px; onclick=window.location.href = 'dashboard-restaurante-edit-produto.html" display:inline;" id="product-${product.id}-editar">Editar</button>
                        <div>
                      </div>
                    </div>
                  </a>
                </td>
              `;
          return tableRow;
        }
        products.forEach((product) => {
          const productElement = createProductElement(product);
          tbody.appendChild(productElement);
          testarDelete()
        });
      }

      showProducts()

      function testarDelete() {
      const buttonsDelete = document.querySelectorAll('[id^="product-deletar"]');
      buttonsDelete.forEach((buttonDelete) => {
          buttonDelete.addEventListener('click', () => {
            const id = buttonDelete.id.split('-')[2];
            deleteUser(id);
          });
        });
      }
      
      async function deleteUser(id) {
              try {
                const response = await fetch(`http://localhost:3000/products/restaurant/${id}`, {
                  method: 'DELETE',
                  headers: {
                    'Content-Type': 'application/json'
                  },
                });

                if (response.ok) {
                  const row = document.querySelector(`#product-deletar-${id}`).parentNode.parentNode;
                  row.parentNode.removeChild(row);
                } else {
                  console.error('Erro ao deletar usuário.');
                }
              } catch (error) {
                console.error(error);
              }
            }

      const btn = document.getElementById("btnLogout");
      btn.addEventListener("click", async (event) => {
        event.preventDefault();
        await logout();
        replaceLocation();
        deleteSession();
      });

      const logout = async (data) => {
        const response = await fetch("http://localhost:3000/auth/signout", {
          method: "POST"
        });
      };

      function replaceLocation() {
        window.location.replace("login.html");
      }

      function deleteSession() {
        localStorage.removeItem("session");
      }
    </script>

    <!-- REQUIRED SCRIPTS -->
    <!-- jQuery -->
    <script src="plugins/jquery/jquery.min.js"></script>
    <!-- Bootstrap -->
    <script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
    <!-- overlayScrollbars -->
    <script src="plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
    <!-- AdminLTE App -->
    <script src="dist/js/adminlte.js"></script>

    <!-- PAGE PLUGINS -->
    <!-- jQuery Mapael -->
    <script src="plugins/jquery-mousewheel/jquery.mousewheel.js"></script>
    <script src="plugins/raphael/raphael.min.js"></script>
    <script src="plugins/jquery-mapael/jquery.mapael.min.js"></script>
    <script src="plugins/jquery-mapael/maps/usa_states.min.js"></script>
    <!-- ChartJS -->
    <script src="plugins/chart.js/Chart.min.js"></script>

    <!-- AdminLTE for demo purposes -->
    <script src="dist/js/demo.js"></script>
    <!-- AdminLTE dashboard demo (This is only for demo purposes) -->
    <script src="dist/js/pages/dashboard2.js"></script>
  </body>
</html>
